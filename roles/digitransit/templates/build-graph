#! /bin/bash -e

PBF_DOWNLOAD_URL="{{ osm_url }}"
PBF_FILE="opentripplanner.osm.pbf"

GTFS_DOWNLOAD_URLS=({% for url in gtfs_urls %} "{{ url }}"  {% endfor %})

ELEVATION_BASE_URL="https://srtm.csi.cgiar.org/wp-content/uploads/files/srtm_5x5/TIFF/"
ELEVATION_FILES=("srtm_38_01" "srtm_38_03" "srtm_39_03" "srtm_38_02" "srtm_39_01" "srtm_39_02")

IMAGE_NAME="mfdz/opentripplanner:{{ otp_docker_tag }}"
CONTAINER_NAME="graph-build"

BUILD_DIR=build
OUTPUT_DIR=latest

docker stop $CONTAINER_NAME || true

mkdir -p build
cd build
echo "TESTING NOW"
# extract elevation zip files
for i in "${ELEVATION_FILES[@]}"
do
  :
  zipfile="${i}.zip"
  tiffile="${i}.tif"
  if [ -f "$tiffile" ]; then
    echo "$zipfile exists."
  else
    echo "$tiffile does not exist. Downloading ..."
    #echo "curl --fail --location -s ${ELEVATION_BASE_URL}${zipfile} -o ${zipfile}"
    df -h
    # -k for allowing http connection, removed -s and fixed variable typos
    # remove --fail to see errors on exit
    curl -k --location "${ELEVATION_BASE_URL}${zipfile}" -o ${zipfile}
    echo "Zip curl executed "
    unzip ${zipfile} ${tiffile}
    echo "Zip unzipped  "
    rm ${zipfile}
    echo "zip removed "
  fi
done

echo "debug PHASE 2 "
curl -k --location "${PBF_DOWNLOAD_URL}" -o ${PBF_FILE}
echo "debug PHASE 3 "
rm -rf gtfs.zip
rm -rf *.gtfs.zip
echo "debug PHASE 4 "
for i in "${GTFS_DOWNLOAD_URLS[@]}"
do
  :
  hash=`cksum <<< "${i}"s | cut -f 1 -d ' '`
  filename=`basename ${i}`
  output="${filename}.${hash}.gtfs.zip"
  curl -L ${i} -o ${output}
done
echo "debug PHASE 5 "
docker pull ${IMAGE_NAME}
docker run -v /var/graph-build/${BUILD_DIR}:/opt/opentripplanner/graph --name ${CONTAINER_NAME} --rm --cpu-shares 512 -e JAVA_OPTS="-Xmx24G" ${IMAGE_NAME} --build --save graph 

echo "${IMAGE_NAME}" > otp-image-version
echo "debug PHASE 6 "
cd ..
mkdir -p ${OUTPUT_DIR}
cp ${BUILD_DIR}/graph.obj  ${OUTPUT_DIR}/
cp ${BUILD_DIR}/*.json ${OUTPUT_DIR}

if [ -d "${BUILD_DIR}/report" ]; then
  cp -r "${BUILD_DIR}/report/" "${OUTPUT_DIR}"
fi
echo "debug PHASE 7 "

#send-to-matrix "üì¶Ô∏è OTP graph build complete on {{ inventory_hostname }}"
